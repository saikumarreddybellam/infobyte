<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edit Question</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" th:href="@{/ui/dashboard}">Quiz App</a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3" sec:authorize="isAuthenticated()">
                Welcome, <span sec:authentication="principal.username"></span>
            </span>
            <form th:action="@{/ui/auth/logout}" method="post" sec:authorize="isAuthenticated()">
                <button type="submit" class="btn btn-outline-light">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Edit Question</h3>
                </div>
                <div class="card-body">
                    <form th:action="@{/ui/admin/questions/{id}/update(id=${questionDto.id})}"
                          th:object="${questionDto}"
                          method="post">
                        <input type="hidden" th:field="*{id}"/>
                        <input type="hidden" th:field="*{quizId}"/>

                        <!-- Question Text Field -->
                        <div class="mb-3">
                            <label for="questionText" class="form-label">Question Text</label>
                            <input type="text" class="form-control"
                                   id="questionText"
                                   th:field="*{questionText}"
                                   required>
                            <div th:if="${#fields.hasErrors('questionText')}"
                                 class="invalid-feedback d-block"
                                 th:errors="*{questionText}">
                            </div>
                        </div>

                        <!-- Options Section -->
                        <div class="mb-3">
                            <label class="form-label">Answer Options</label>

                            <!-- Global Options Error -->
                            <div th:if="${#fields.hasErrors('options')}" class="alert alert-danger">
                                <ul class="mb-0">
                                    <li th:each="err : ${#fields.errors('options')}" th:text="${err}"></li>
                                </ul>
                            </div>

                            <div id="options-container">
                                <!-- Existing Options -->
                                <div th:each="option, iter : ${questionDto.options}" class="card mb-3 option-card">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Option <span th:text="${iter.index + 1}"></span></label>
                                            <input type="text"
                                                   class="form-control"
                                                   th:name="|options[${iter.index}].text|"
                                                   th:value="${option.text}"
                                                   required>
                                            <div th:if="${#fields.hasErrors('options[' + iter.index + '].text')}"
                                                 class="invalid-feedback d-block"
                                                 th:errors="*{options[__${iter.index}__].text}">
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="correctOptionIndex"
                                                   th:value="${iter.index}"
                                                   th:checked="${option.correct}"
                                                   required>
                                            <label class="form-check-label">Correct Answer</label>
                                        </div>
                                        <input type="hidden"
                                               th:name="|options[${iter.index}].id|"
                                               th:value="${option.id}">
                                        <input type="hidden"
                                               th:name="|options[${iter.index}].questionId|"
                                               th:value="${questionDto.id}">
                                        <input type="hidden"
                                               th:name="|options[${iter.index}].correct|"
                                               th:value="${option.correct}">
                                    </div>
                                </div>
                            </div>

                            <!-- Add Option Button -->
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption()">
                                <i class="bi bi-plus"></i> Add Option
                            </button>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a th:href="@{/ui/admin/quizzes/{quizId}/questions(quizId=${questionDto.quizId})}"
                               class="btn btn-secondary me-md-2">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Update Question
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let optionCount = [[${questionDto.options != null ? questionDto.options.size() : 0}]];
    const quizId = [[${questionDto.quizId}]];
    const questionId = [[${questionDto.id}]];

    function addOption() {
        const container = document.getElementById('options-container');
        const newOption = document.createElement('div');
        newOption.className = 'card mb-3 option-card';
        newOption.innerHTML = `
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Option ${optionCount + 1}</label>
                    <input type="text"
                           class="form-control"
                           name="options[${optionCount}].text"
                           required>
                </div>
                <div class="form-check">
                    <input class="form-check-input"
                           type="radio"
                           name="correctOptionIndex"
                           value="${optionCount}">
                    <label class="form-check-label">Correct Answer</label>
                </div>
                <input type="hidden" name="options[${optionCount}].id" value="">
                <input type="hidden" name="options[${optionCount}].questionId" value="${questionId}">
                <input type="hidden" name="options[${optionCount}].correct" value="false">
            </div>
        `;
        container.appendChild(newOption);
        optionCount++;
    }

    // Update correct flag when radio button is clicked
    document.addEventListener('change', function(e) {
        if (e.target && e.target.name === 'correctOptionIndex') {
            const optionCards = document.querySelectorAll('.option-card');
            optionCards.forEach((card, index) => {
                const correctInput = card.querySelector('input[name^="options"][name$="correct"]');
                if (index == e.target.value) {
                    correctInput.value = 'true';
                } else {
                    correctInput.value = 'false';
                }
            });
        }
    });
    /*]]>*/
</script>

<script src="/js/bootstrap.bundle.min.js"></script>
</body>
</html>